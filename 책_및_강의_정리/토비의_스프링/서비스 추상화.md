# 서비스 추상화


## 트랜잭션

트랜잭션이란 "더 이상 나눌 수 없는 단위 작업"을 말한다. 간단하게 말해서 DB에 데이터를 저장하던도중에 중간에 예외가 발생한다면 아예 작업이 시작되지 않은 것처럼 작업 초기 상태로 되돌려 놓아야 한다는 것을 의미한다. 

예를들어 은행의 계좌이체 작업과 같은 경우를 생각해보면 A가 B에게 돈( x원 )을 송금할 때, A 의 계좌에는 -x , B의 계좌에는 +x 가 되어야 한다. 이러한 경우 A 계좌에 -x 하는 작업과 B 계좌에 +x 하는 작업을 하나의 작업단위로 보는 것이 좋으며 중간에 문제가 생긴 경우 초기 상태로 되돌려놓아야한다. 

이렇게 초기상태로 되돌려 놓는 것을 트랜잭션 롤백(Rollback), 작업이 완료되어 확정 처리 하는 것을 트랜잭션 커밋(Commit)이라고 한다.

### 트랜잭션 경계설정

> 트랜잭션이 시작되고 끝나는 위치를 "트랜잭션의 경계"라고 한다.

그렇다면 작업이 시작되고 끝난다는 것을 어떻게 정의해야할까 ? 토비의 스프링 챕터 1? 에서 JDBC를 사용했을 때와 같이 DB에서 Connection을 가져오고 닫는 위치를 트랜잭션의 경계로 잡아도 될 것 같다. ( 트랜잭션은 하나의 Connection 오브젝트 안에서 만들어지기 때문 ) 하지만 토비의 스프링 챕터 5에서와 같이 데이터 접근 계층(DAO)와 로직 계층(Service) 을 분리하여 사용한다면 이는 어려워지기 때문에 트랜잭션의 경계를 로직 계층으로 가지고 와야한다.

- 트랜잭션 경계설정하기
```java
public class MyService {

	@Autowired
	private MyDao myDao;
	
	public void myLogic() {
		Connection c = ..

		myDao.useData(c);
	}
	
}
```

하지만 위와 같이 트랜잭션의 경계를 설정하는 것은 아래와 같이 여러 문제를 가진다.

1. JdbcTemplate을 사용하지 못한다.
2. 스프링 컨테이너에서 싱글톤으로 생성되어 사용되는 MyService 객체의 특성때문에 한 개의 Connection 객체를 여러 사용자가 동시에 공유하여 사용할 것이다.
3. 데이터 액세스 기술에 독립적일 수 없다.

### 데이터 액세스 기술에 독립적인 트랜잭션 사용하기
// 스프링에서 여러가지 트랜잭션 방법을 추상화하여 사용하는 방법

스프링은 JDBC, 하이버네이트 등에서 사용하는 다양한 트랜잭션을 추상화하여 사용할 수 있도록 트랜잭션 API 를 제공한다.




### 


트랜잭션의 경계선
커넥션 하나당 하나의 트랜잭션

UserService 클래스의 코드를 변경하지 않은채로 UserService의 add() 메서드가 실행될 때 예외가 발생하는 경우를 테스트하려면 어떻게 해야할까? 

- 방법 1. UserService 클래스 복사한 후 사용하기
- 방법 2. 상속과 오버라이딩을 통한 TestUserService 구현하기

당연하게도 UserService를 복사하여 사용하는 것보다는 상속과 오버라이딩을 통한 테스트용 UserService 클래스를 만드는 것이 좋다.









